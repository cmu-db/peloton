# Notes from tq5124

## Morsel-based Parallelism

See paper at [link](http://15721.courses.cs.cmu.edu/spring2017/papers/17-execution/p743-leis.pdf)

* the architecture of the dispatcher, see figure 5
  * This list only contains pipeline jobs whose prerequisites have already been processed.
  * dispatcher is not a seperate thread
  * the dispatcher is implemented as a lock-free data structure. The dispatcher’s code is then executed by the work requesting query evaluation thread itself.
  * guarantees load balancing and skew resistance
    * If, for some reason, a core finishes processing all morsels on its particular socket, the dispatcher will “steal work” from another core
    * assign morsels on a dif- ferent socket
  * we currently avoid to execute multiple pipelines from one query in parallel
  * If any of these events happen, the involved query is marked in the dispatcher. The marker is checked whenever a morsel of that query is finished, therefore, very soon all worker threads will stop work- ing on this query
* NUMA-aware
  * The most obvious way to do this is round-robin assignment
  * A better alternative is to par- tition relations using the hash value of some “important” attribute.
  * A typical example (from TPC-H) would be to partition orders and lineitem on the orderkey attribute.
  
## Codegen

Walk through the `table_scan_translator_test`

1. [table_scan_translator_test.cpp#AllColumnsScan](https://github.com/pmenon/peloton-1/blob/codegen/test/codegen/table_scan_translator_test.cpp#L71)
2. [codegen_test_util.cpp#CompileAndExecute](https://github.com/pmenon/peloton-1/blob/codegen/test/codegen/codegen_test_util.cpp#L115)
3. [query_compiler.cpp#Compile](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/query_compiler.cpp#L38)
4. [compilation_context.cpp#GeneratePlan](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/compilation_context.cpp#L87)
5. [compilation_context.cpp#GeneratePlanFunction](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/compilation_context.cpp#L175)
6. [compliation_context.cpp#Produce](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/compilation_context.cpp#L58)
7. [table_scan_translator.cpp#Produce](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/table_scan_translator.cpp#L78)
8. [table.cpp#GenerateVectorizedScan](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/table.cpp#L62)
9. [table.cpp#DoGenerateScan](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/table.cpp#L106)
10. [tile_group.cpp#GenerateVectorizedTidScan](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/tile_group.cpp#L80)
11. [table_scan_translator.cpp::ScanConsumer#ScanBody](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/table_scan_translator.cpp#L111)
12. [table_scan_translator.cpp::ScanConsumer#FilterRows](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/table_scan_translator.cpp#L197)

How would a table scan get tuples number?
1. [table.cpp#DoGenerateScan](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/table.cpp#L76)
2. [table.cpp#GetTileGroupCount](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/table.cpp#L31)
3. [data_table_proxy.cpp#GetFunction](https://github.com/tq5124/peloton-1/blob/codegen/src/codegen/data_table_proxy.cpp#L65)

Which functions in plan_func needs to be thread-safe?

* PerformVectorizedRead at [table_scan_translator_test](https://github.com/tq5124/peloton-1/blob/multi/src/codegen/table_scan_translator.cpp#L171)

```
(gdb) backtrace
#0  0x00007ffff6697990 in std::equal_to<unsigned int>::operator() (this=0x7a0668, __x=@0x7fffe22ffa98: 37, __y=@0x8: <error reading variable>) at /usr/include/c++/5/bits/stl_function.h:357
#1  0x00007ffff673bc7f in std::__detail::_Equal_helper<unsigned int, std::pair<unsigned int const, std::unordered_map<unsigned int, peloton::RWType, std::hash<unsigned int>, std::equal_to<unsigned int>, std::allocator<std::pair<unsigned int const, peloton::RWType> > > >, std::__detail::_Select1st, std::equal_to<unsigned int>, unsigned long, false>::_S_equals (__eq=..., __extract=..., __k=@0x7fffe22ffa98: 37, __n=0x0) at /usr/include/c++/5/bits/hashtable_policy.h:1333
#2  0x00007ffff673b704 in std::__detail::_Hashtable_base<unsigned int, std::pair<unsigned int const, std::unordered_map<unsigned int, peloton::RWType, std::hash<unsigned int>, std::equal_to<unsigned int>, std::allocator<std::pair<unsigned int const, peloton::RWType> > > >, std::__detail::_Select1st, std::equal_to<unsigned int>, std::hash<unsigned int>, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Hashtable_traits<false, false, true> >::_M_equals (this=0x7a0668, __k=@0x7fffe22ffa98: 37, __c=37, __n=0x0) at /usr/include/c++/5/bits/hashtable_policy.h:1704
#3  0x00007ffff673afb9 in std::_Hashtable<unsigned int, std::pair<unsigned int const, std::unordered_map<unsigned int, peloton::RWType, std::hash<unsigned int>, std::equal_to<unsigned int>, std::allocator<std::pair<unsigned int const, peloton::RWType> > > >, std::allocator<std::pair<unsigned int const, std::unordered_map<unsigned int, peloton::RWType, std::hash<unsigned int>, std::equal_to<unsigned int>, std::allocator<std::pair<unsigned int const, peloton::RWType> > > > >, std::__detail::_Select1st, std::equal_to<unsigned int>, std::hash<unsigned int>, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits<false, false, true> >::_M_find_before_node (this=0x7a0668, __n=1, __k=@0x7fffe22ffa98: 37, __code=37) at /usr/include/c++/5/bits/hashtable.h:1433
#4  0x00007ffff673a73c in std::_Hashtable<unsigned int, std::pair<unsigned int const, std::unordered_map<unsigned int, peloton::RWType, std::hash<unsigned int>, std::equal_to<unsigned int>, std::allocator<std::pair<unsigned int const, peloton::RWType> > > >, std::allocator<std::pair<unsigned int const, std::unordered_map<unsigned int, peloton::RWType, std::hash<unsigned int>, std::equal_to<unsigned int>, std::allocator<std::pair<unsigned int const, peloton::RWType> > > > >, std::__detail::_Select1st, std::equal_to<unsigned int>, std::hash<unsigned int>, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits<false, false, true> >::_M_find_node (this=0x7a0668, __bkt=1, __key=@0x7fffe22ffa98: 37, __c=37) at /usr/include/c++/5/bits/hashtable.h:632
#5  0x00007ffff673a1ff in std::_Hashtable<unsigned int, std::pair<unsigned int const, std::unordered_map<unsigned int, peloton::RWType, std::hash<unsigned int>, std::equal_to<unsigned int>, std::allocator<std::pair<unsigned int const, peloton::RWType> > > >, std::allocator<std::pair<unsigned int const, std::unordered_map<unsigned int, peloton::RWType, std::hash<unsigned int>, std::equal_to<unsigned int>, std::allocator<std::pair<unsigned int const, peloton::RWType> > > > >, std::__detail::_Select1st, std::equal_to<unsigned int>, std::hash<unsigned int>, std::__detail::_Mod_range_hashing, std::__detail::_Default_ranged_hash, std::__detail::_Prime_rehash_policy, std::__detail::_Hashtable_traits<false, false, true> >::find (this=0x7a0668, __k=@0x7fffe22ffa98: 37) at /usr/include/c++/5/bits/hashtable.h:1307
#6  0x00007ffff673a021 in std::unordered_map<unsigned int, std::unordered_map<unsigned int, peloton::RWType, std::hash<unsigned int>, std::equal_to<unsigned int>, std::allocator<std::pair<unsigned int const, peloton::RWType> > >, std::hash<unsigned int>, std::equal_to<unsigned int>, std::allocator<std::pair<unsigned int const, std::unordered_map<unsigned int, peloton::RWType, std::hash<unsigned int>, std::equal_to<unsigned int>, std::allocator<std::pair<unsigned int const, peloton::RWType> > > > > >::find (this=0x7a0668, __x=@0x7fffe22ffa98: 37) at /usr/include/c++/5/bits/unordered_map.h:615
#7  0x00007ffff6739163 in peloton::concurrency::Transaction::RecordRead (this=0x7a0640, location=...) at /peloton/src/concurrency/transaction.cpp:69
#8  0x00007ffff67317cb in peloton::concurrency::TimestampOrderingTransactionManager::PerformRead (this=0x7ffff7dc84c0 <peloton::concurrency::TimestampOrderingTransactionManager::GetInstance()::txn_manager>, current_txn=0x7a0640, 
    location=..., acquire_ownership=false) at /peloton/src/concurrency/timestamp_ordering_transaction_manager.cpp:458
#9  0x00007ffff66fa27a in peloton::codegen::TransactionRuntime::PerformVectorizedRead (txn=..., tile_group=..., tid_start=0, tid_end=32, selection_vector=0x7fffe22ffcc0) at /peloton/src/codegen/transaction_runtime.cpp:55
#10 0x00007ffff7ff51ee in ?? ()
#11 0x0000000000000001 in ?? ()
#12 0x000000000088d7b0 in ?? ()
#13 0x0000000000000000 in ?? ()
```

* emplace_push at [buffer_consumer](https://github.com/tq5124/peloton-1/blob/multi/src/codegen/buffering_consumer.cpp#L57)


